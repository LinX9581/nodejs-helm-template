# Default values for nodejs-helm-template.
# Gateway API + GKE 版本

replicaCount: 2

image:
  repository: asia-docker.pkg.dev/nownews-terraform/nodejs-dev-template/nodejs-dev-fn-template
  pullPolicy: IfNotPresent
  tag: "1.0.0"

imagePullSecrets: []
nameOverride: ""
fullnameOverride: ""

serviceAccount:
  create: true
  annotations: {}
  name: ""

podAnnotations: {}
podSecurityContext:
  runAsNonRoot: true
  seccompProfile:
    type: RuntimeDefault
securityContext:
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL

otel:
  enabled: true
  injectorAnnotationKey: instrumentation.opentelemetry.io/inject-nodejs
  injectorAnnotationValue: "true"

# ---------- Service ----------
service:
  type: ClusterIP
  port: 3011

application:
  port: 3011

configMap:
  create: true
  # 空字串時會使用: <release-fullname>-env
  name: ""
  data:
    DB_HOST: "172.16.2.200"
    DB_USER: "docker"
    PORT: "3011"
    DEV_PORT: "4006"

envFrom:
  configMap:
    enabled: true
    # 空字串時會使用 configMap.name / <release-fullname>-env
    name: ""
  configMapRefs: []
  # Put sensitive values (DB password, tokens) in Kubernetes Secret.
  # Example:
  # kubectl -n nodejs-helm-template create secret generic nodejs-helm-template-secrets \
  #   --from-literal=DB_PASSWORD='replace-me'
  secretRefs: []

# ---------- Gateway API (取代 nginx-ingress) ----------
gateway:
  enabled: true
  gatewayName: app-gateway        # argocd.sh 建立的 Gateway
  gatewayNamespace: default

  # 主要路由 (非重定向的 hostname)
  routes:
    - hostname: nodejs.linx.bar

  # 特殊路徑規則 (可選)
  # 不列在這裡的路徑都會走預設的 / → backendRef
  rules:
    # /test → 重定向到首頁
    - path: /test
      pathType: Exact
      redirect:
        path: /
        statusCode: 302

    # /wp-content, /wp-admin → 走 app 處理 (回 404)
    - path: /wp-content
      pathType: PathPrefix

    - path: /wp-admin
      pathType: PathPrefix

    # /news, /cat 等複雜路由 → 走 app 內部處理
    # Gateway API 不支援 regex capture group rewrite
    # 建議在 Node.js app 內用 express router 處理:
    #   app.get('/news/*', (req, res) => { ... })
    #   app.get('/cat/*', (req, res) => { ... })
    - path: /news
      pathType: PathPrefix

    - path: /cat
      pathType: PathPrefix

  # 網域重定向 (整個 host → 另一個 host)
  redirectRoutes:
    - hostname: home.linx.bar
      targetHostname: nodejs.linx.bar
      statusCode: 301

# ---------- Resources ----------
resources: {}
  # limits:
  #   cpu: 100m
  #   memory: 128Mi
  # requests:
  #   cpu: 100m
  #   memory: 128Mi

# ---------- Autoscaling ----------
autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 10
  targetCPUUtilizationPercentage: 80

updateStrategy:
  type: RollingUpdate
  maxUnavailable: 0
  maxSurge: 1

nodeSelector:
  workload: app
tolerations: []
affinity: {}
